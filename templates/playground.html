{% extends "base.html" %}

{% block title %}Playground - HalluciDetect{% endblock %}
{% block header_title %}Playground{% endblock %}

{% block content %}
<div class="playground-container">
    <!-- Quick Actions Bar -->
    <div class="quick-actions-bar">
        <div class="quick-actions-left">
            <!-- Template Selector -->
            <div class="template-selector">
                <button type="button" class="btn btn-secondary" id="template-btn" onclick="toggleTemplateDropdown()">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: 16px; height: 16px;">
                        <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/>
                        <polyline points="14 2 14 8 20 8"/>
                        <line x1="16" y1="13" x2="8" y2="13"/>
                        <line x1="16" y1="17" x2="8" y2="17"/>
                    </svg>
                    <span class="btn-text">Load Template</span>
                </button>
                <div class="template-dropdown" id="template-dropdown">
                    <div class="template-dropdown-header">
                        <span>Quick Templates</span>
                        <a href="{{ url_for('templates_page') }}" class="template-dropdown-link">View All ‚Üí</a>
                    </div>
                    <div class="template-dropdown-list" id="template-list">
                        <div class="template-dropdown-loading">Loading...</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="quick-actions-right">
            <!-- Model Comparison Toggle -->
            <label class="comparison-toggle">
                <input type="checkbox" id="comparison-mode" onchange="toggleComparisonMode()">
                <span class="comparison-toggle-label">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;">
                        <rect x="3" y="3" width="7" height="7"/>
                        <rect x="14" y="3" width="7" height="7"/>
                        <rect x="14" y="14" width="7" height="7"/>
                        <rect x="3" y="14" width="7" height="7"/>
                    </svg>
                    <span class="toggle-text">Compare Models</span>
                </span>
            </label>
        </div>
    </div>

    <div class="grid-2" id="main-grid">
        <!-- Input Panel -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Evaluation Input</h3>
            </div>
            <div class="card-body">
                <form id="evaluate-form">
                    <!-- Model Selection Row -->
                    <div class="model-selection-row" id="model-selection-row">
                        <div class="form-group model-select-group">
                            <label class="form-label">
                                Model
                                <span class="label-badge" id="model-badge-1">Primary</span>
                            </label>
                            <select class="form-select" id="model-select" name="model">
                                <optgroup label="OpenAI">
                                    <option value="gpt-4o-mini" selected>GPT-4o Mini</option>
                                    <option value="gpt-4o">GPT-4o</option>
                                    <option value="o1-preview">o1 Preview (Reasoning)</option>
                                    <option value="o1-mini">o1 Mini (Reasoning)</option>
                                    <option value="gpt-4-turbo">GPT-4 Turbo</option>
                                </optgroup>
                                <optgroup label="Anthropic">
                                    <option value="claude-3-5-sonnet-20241022">Claude 3.5 Sonnet</option>
                                    <option value="claude-3-5-haiku-20241022">Claude 3.5 Haiku</option>
                                    <option value="claude-3-opus-20240229">Claude 3 Opus</option>
                                </optgroup>
                                <optgroup label="Google">
                                    <option value="google/gemini-2.0-flash-exp">Gemini 2.0 Flash</option>
                                    <option value="google/gemini-1.5-pro">Gemini 1.5 Pro</option>
                                    <option value="google/gemini-1.5-flash">Gemini 1.5 Flash</option>
                                </optgroup>
                                <optgroup label="Meta Llama">
                                    <option value="meta-llama/llama-3.3-70b-instruct">Llama 3.3 70B</option>
                                    <option value="meta-llama/llama-3.2-90b-vision-instruct">Llama 3.2 90B Vision</option>
                                    <option value="meta-llama/llama-3.1-405b-instruct">Llama 3.1 405B</option>
                                </optgroup>
                                <optgroup label="Free (via OpenRouter)">
                                    <option value="meta-llama/llama-3.2-3b-instruct:free">Llama 3.2 3B (Free)</option>
                                    <option value="google/gemma-2-9b-it:free">Gemma 2 9B (Free)</option>
                                    <option value="mistralai/mistral-7b-instruct:free">Mistral 7B (Free)</option>
                                    <option value="qwen/qwen-2.5-7b-instruct:free">Qwen 2.5 7B (Free)</option>
                                </optgroup>
                            </select>
                            <div class="cost-estimate" id="cost-estimate-1">
                                <span class="cost-label">Est. cost:</span>
                                <span class="cost-value" id="cost-value-1">~$0.001</span>
                            </div>
                        </div>
                        
                        <!-- Second Model (Comparison Mode) -->
                        <div class="form-group model-select-group comparison-model" id="model-2-group" style="display: none;">
                            <label class="form-label">
                                Model
                                <span class="label-badge secondary">Compare</span>
                            </label>
                            <select class="form-select" id="model-select-2" name="model_2">
                                <optgroup label="OpenAI">
                                    <option value="gpt-4o-mini">GPT-4o Mini</option>
                                    <option value="gpt-4o">GPT-4o</option>
                                    <option value="o1-preview">o1 Preview (Reasoning)</option>
                                    <option value="o1-mini">o1 Mini (Reasoning)</option>
                                    <option value="gpt-4-turbo">GPT-4 Turbo</option>
                                </optgroup>
                                <optgroup label="Anthropic">
                                    <option value="claude-3-5-sonnet-20241022" selected>Claude 3.5 Sonnet</option>
                                    <option value="claude-3-5-haiku-20241022">Claude 3.5 Haiku</option>
                                    <option value="claude-3-opus-20240229">Claude 3 Opus</option>
                                </optgroup>
                                <optgroup label="Google">
                                    <option value="google/gemini-2.0-flash-exp">Gemini 2.0 Flash</option>
                                    <option value="google/gemini-1.5-pro">Gemini 1.5 Pro</option>
                                    <option value="google/gemini-1.5-flash">Gemini 1.5 Flash</option>
                                </optgroup>
                                <optgroup label="Meta Llama">
                                    <option value="meta-llama/llama-3.3-70b-instruct">Llama 3.3 70B</option>
                                    <option value="meta-llama/llama-3.2-90b-vision-instruct">Llama 3.2 90B Vision</option>
                                    <option value="meta-llama/llama-3.1-405b-instruct">Llama 3.1 405B</option>
                                </optgroup>
                                <optgroup label="Free (via OpenRouter)">
                                    <option value="meta-llama/llama-3.2-3b-instruct:free">Llama 3.2 3B (Free)</option>
                                    <option value="google/gemma-2-9b-it:free">Gemma 2 9B (Free)</option>
                                    <option value="mistralai/mistral-7b-instruct:free">Mistral 7B (Free)</option>
                                    <option value="qwen/qwen-2.5-7b-instruct:free">Qwen 2.5 7B (Free)</option>
                                </optgroup>
                            </select>
                            <div class="cost-estimate" id="cost-estimate-2">
                                <span class="cost-label">Est. cost:</span>
                                <span class="cost-value" id="cost-value-2">~$0.003</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Prompt Version</label>
                        <input type="text" class="form-input" id="prompt-version" name="prompt_version" value="v1" placeholder="e.g., v1, v2, experiment-A">
                        <p class="form-hint">Use version tags to track prompt iterations</p>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Prompt</label>
                        <textarea class="form-textarea" id="prompt-input" name="prompt" placeholder="Enter the prompt to evaluate..." rows="5" required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">
                            Reference Text (Ground Truth)
                            <span class="tooltip-trigger" data-tooltip="Providing expected output helps improve evaluation accuracy by comparing semantic similarity">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;">
                                    <circle cx="12" cy="12" r="10"/>
                                    <path d="M9.09 9a3 3 0 015.83 1c0 2-3 3-3 3"/>
                                    <line x1="12" y1="17" x2="12.01" y2="17"/>
                                </svg>
                            </span>
                        </label>
                        <textarea class="form-textarea" id="reference-input" name="reference" placeholder="Optional: Enter the expected/correct answer for comparison..." rows="4"></textarea>
                    </div>
                    
                    <button type="submit" class="btn btn-primary btn-lg" style="width: 100%;" id="evaluate-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polygon points="5 3 19 12 5 21 5 3"/>
                        </svg>
                        <span id="evaluate-btn-text">Run Evaluation</span>
                    </button>
                </form>
            </div>
        </div>
        
        <!-- Results Panel -->
        <div class="results-column">
            <!-- Single Result Panel -->
            <div class="result-panel" id="result-panel" style="display: none;">
                <div class="result-header">
                    <div class="result-header-left">
                        <h3 class="card-title">Evaluation Result</h3>
                        <span class="badge" id="result-status"></span>
                    </div>
                    <div class="result-meta">
                        <span class="result-meta-item" id="result-latency" title="Response time">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;">
                                <circle cx="12" cy="12" r="10"/>
                                <polyline points="12 6 12 12 16 14"/>
                            </svg>
                            <span>--</span>
                        </span>
                        <span class="result-meta-item" id="result-cost" title="Estimated cost">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;">
                                <line x1="12" y1="1" x2="12" y2="23"/>
                                <path d="M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/>
                            </svg>
                            <span>--</span>
                        </span>
                    </div>
                </div>
                <div class="result-body">
                    <div class="result-section">
                        <div class="result-section-title">LLM Output</div>
                        <div class="result-output" id="result-output"></div>
                    </div>
                    
                    <div class="result-section">
                        <div class="result-section-title">Scores</div>
                        <div class="scores-grid">
                            <div class="score-item">
                                <div class="score-item-label">
                                    Overall Confidence
                                    <span class="tooltip-trigger" data-tooltip="How confident the system is that the output is factually accurate (higher is better)">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 12px; height: 12px;">
                                            <circle cx="12" cy="12" r="10"/>
                                            <path d="M9.09 9a3 3 0 015.83 1c0 2-3 3-3 3"/>
                                            <line x1="12" y1="17" x2="12.01" y2="17"/>
                                        </svg>
                                    </span>
                                </div>
                                <div class="score-item-value" id="score-confidence">--</div>
                            </div>
                            <div class="score-item">
                                <div class="score-item-label">
                                    Hallucination Score
                                    <span class="tooltip-trigger" data-tooltip="Likelihood the output contains fabricated information (lower is better)">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 12px; height: 12px;">
                                            <circle cx="12" cy="12" r="10"/>
                                            <path d="M9.09 9a3 3 0 015.83 1c0 2-3 3-3 3"/>
                                            <line x1="12" y1="17" x2="12.01" y2="17"/>
                                        </svg>
                                    </span>
                                </div>
                                <div class="score-item-value" id="score-hallucination">--</div>
                            </div>
                            <div class="score-item">
                                <div class="score-item-label">
                                    Semantic Similarity
                                    <span class="tooltip-trigger" data-tooltip="How closely the output matches your reference text in meaning (higher is better)">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 12px; height: 12px;">
                                            <circle cx="12" cy="12" r="10"/>
                                            <path d="M9.09 9a3 3 0 015.83 1c0 2-3 3-3 3"/>
                                            <line x1="12" y1="17" x2="12.01" y2="17"/>
                                        </svg>
                                    </span>
                                </div>
                                <div class="score-item-value" id="score-semantic">--</div>
                            </div>
                            <div class="score-item">
                                <div class="score-item-label">
                                    Fact Check Score
                                    <span class="tooltip-trigger" data-tooltip="Percentage of claims verified against Wikipedia and fact-check databases (higher is better)">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 12px; height: 12px;">
                                            <circle cx="12" cy="12" r="10"/>
                                            <path d="M9.09 9a3 3 0 015.83 1c0 2-3 3-3 3"/>
                                            <line x1="12" y1="17" x2="12.01" y2="17"/>
                                        </svg>
                                    </span>
                                </div>
                                <div class="score-item-value" id="score-factcheck">--</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="result-section">
                        <div class="result-section-title">Analysis Breakdown</div>
                        <div id="analysis-details"></div>
                    </div>
                </div>
            </div>
            
            <!-- Comparison Results Panel -->
            <div class="comparison-results" id="comparison-results" style="display: none;">
                <div class="comparison-header">
                    <h3 class="card-title">Model Comparison</h3>
                    <div class="comparison-summary" id="comparison-summary"></div>
                </div>
                <div class="comparison-grid">
                    <!-- Model 1 Result -->
                    <div class="comparison-card" id="comparison-card-1">
                        <div class="comparison-card-header">
                            <span class="comparison-model-name" id="comparison-model-1">Model 1</span>
                            <span class="badge" id="comparison-status-1"></span>
                        </div>
                        <div class="comparison-card-meta">
                            <span id="comparison-latency-1">--</span>
                            <span id="comparison-cost-1">--</span>
                        </div>
                        <div class="comparison-card-scores">
                            <div class="comparison-score">
                                <span class="comparison-score-label">Confidence</span>
                                <span class="comparison-score-value" id="comparison-confidence-1">--</span>
                            </div>
                            <div class="comparison-score">
                                <span class="comparison-score-label">Hallucination</span>
                                <span class="comparison-score-value" id="comparison-hallucination-1">--</span>
                            </div>
                        </div>
                        <div class="comparison-card-output" id="comparison-output-1"></div>
                    </div>
                    
                    <!-- Model 2 Result -->
                    <div class="comparison-card" id="comparison-card-2">
                        <div class="comparison-card-header">
                            <span class="comparison-model-name" id="comparison-model-2">Model 2</span>
                            <span class="badge" id="comparison-status-2"></span>
                        </div>
                        <div class="comparison-card-meta">
                            <span id="comparison-latency-2">--</span>
                            <span id="comparison-cost-2">--</span>
                        </div>
                        <div class="comparison-card-scores">
                            <div class="comparison-score">
                                <span class="comparison-score-label">Confidence</span>
                                <span class="comparison-score-value" id="comparison-confidence-2">--</span>
                            </div>
                            <div class="comparison-score">
                                <span class="comparison-score-label">Hallucination</span>
                                <span class="comparison-score-value" id="comparison-hallucination-2">--</span>
                            </div>
                        </div>
                        <div class="comparison-card-output" id="comparison-output-2"></div>
                    </div>
                </div>
            </div>
            
            <!-- Empty State -->
            <div class="card" id="empty-state">
                <div class="card-body">
                    <div class="empty-state">
                        <svg class="empty-state-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"/>
                            <line x1="12" y1="16" x2="12" y2="12"/>
                            <line x1="12" y1="8" x2="12.01" y2="8"/>
                        </svg>
                        <h3 class="empty-state-title">No Evaluation Yet</h3>
                        <p class="empty-state-text">Enter a prompt and click "Run Evaluation" to analyze LLM outputs for potential hallucinations.</p>
                    </div>
                </div>
            </div>
            
            <!-- Loading State -->
            <div class="card" id="loading-state" style="display: none;">
                <div class="card-body">
                    <div class="empty-state">
                        <div class="spinner" style="margin: 0 auto 20px;"></div>
                        <h3 class="empty-state-title" id="loading-title">Evaluating...</h3>
                        <p class="empty-state-text" id="loading-text">Generating LLM response and analyzing for hallucinations</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Playground-specific styles */
.playground-container {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.quick-actions-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 12px;
}

.quick-actions-left,
.quick-actions-right {
    display: flex;
    align-items: center;
    gap: 12px;
}

/* Template Selector */
.template-selector {
    position: relative;
}

.template-dropdown {
    display: none;
    position: absolute;
    top: calc(100% + 8px);
    left: 0;
    min-width: 320px;
    max-width: 400px;
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    box-shadow: var(--shadow-lg);
    z-index: 100;
    overflow: hidden;
}

.template-dropdown.show {
    display: block;
}

.template-dropdown-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 16px;
    border-bottom: 1px solid var(--border-color);
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    color: var(--text-muted);
}

.template-dropdown-link {
    font-size: 0.75rem;
    font-weight: 500;
    text-transform: none;
}

.template-dropdown-list {
    max-height: 300px;
    overflow-y: auto;
}

.template-dropdown-item {
    display: block;
    padding: 12px 16px;
    border-bottom: 1px solid var(--border-color);
    cursor: pointer;
    transition: background var(--transition-fast);
}

.template-dropdown-item:last-child {
    border-bottom: none;
}

.template-dropdown-item:hover {
    background: var(--bg-hover);
}

.template-dropdown-item-title {
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--text-primary);
    margin-bottom: 4px;
}

.template-dropdown-item-desc {
    font-size: 0.75rem;
    color: var(--text-muted);
    display: -webkit-box;
    -webkit-line-clamp: 1;
    line-clamp: 1;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.template-dropdown-loading {
    padding: 24px;
    text-align: center;
    color: var(--text-muted);
    font-size: 0.875rem;
}

/* Comparison Toggle */
.comparison-toggle {
    display: flex;
    align-items: center;
    cursor: pointer;
}

.comparison-toggle input {
    display: none;
}

.comparison-toggle-label {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 16px;
    background: var(--bg-tertiary);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    font-size: 0.875rem;
    color: var(--text-secondary);
    transition: all var(--transition-fast);
}

.comparison-toggle input:checked + .comparison-toggle-label {
    background: var(--accent-primary);
    border-color: var(--accent-primary);
    color: white;
}

/* Model Selection Row */
.model-selection-row {
    display: flex;
    gap: 16px;
    margin-bottom: 20px;
}

.model-select-group {
    flex: 1;
    margin-bottom: 0 !important;
}

.label-badge {
    display: inline-block;
    padding: 2px 8px;
    font-size: 0.65rem;
    font-weight: 600;
    text-transform: uppercase;
    background: var(--accent-primary);
    color: white;
    border-radius: 4px;
    margin-left: 8px;
}

.label-badge.secondary {
    background: var(--accent-secondary);
}

.cost-estimate {
    display: flex;
    align-items: center;
    gap: 6px;
    margin-top: 6px;
    font-size: 0.75rem;
}

.cost-label {
    color: var(--text-muted);
}

.cost-value {
    color: var(--accent-success);
    font-weight: 500;
    font-family: 'JetBrains Mono', monospace;
}

/* Tooltips */
.tooltip-trigger {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    margin-left: 4px;
    color: var(--text-muted);
    cursor: help;
    position: relative;
}

.tooltip-trigger::after {
    content: attr(data-tooltip);
    position: absolute;
    bottom: calc(100% + 8px);
    left: 50%;
    transform: translateX(-50%);
    padding: 8px 12px;
    background: var(--bg-primary);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    font-size: 0.75rem;
    font-weight: 400;
    color: var(--text-secondary);
    white-space: normal;
    width: 200px;
    text-align: center;
    opacity: 0;
    visibility: hidden;
    transition: all var(--transition-fast);
    z-index: 100;
    box-shadow: var(--shadow-lg);
}

.tooltip-trigger:hover::after {
    opacity: 1;
    visibility: visible;
}

/* Result Meta */
.result-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 12px;
}

.result-header-left {
    display: flex;
    align-items: center;
    gap: 12px;
}

.result-meta {
    display: flex;
    gap: 16px;
}

.result-meta-item {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 0.8125rem;
    color: var(--text-muted);
    font-family: 'JetBrains Mono', monospace;
}

/* Comparison Results */
.comparison-results {
    background: var(--bg-card);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    overflow: hidden;
}

.comparison-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 20px;
    border-bottom: 1px solid var(--border-color);
    flex-wrap: wrap;
    gap: 12px;
}

.comparison-summary {
    font-size: 0.875rem;
    color: var(--text-secondary);
}

.comparison-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1px;
    background: var(--border-color);
}

.comparison-card {
    background: var(--bg-card);
    padding: 16px;
}

.comparison-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
}

.comparison-model-name {
    font-weight: 600;
    font-size: 0.875rem;
    color: var(--text-primary);
}

.comparison-card-meta {
    display: flex;
    gap: 16px;
    margin-bottom: 12px;
    font-size: 0.75rem;
    color: var(--text-muted);
    font-family: 'JetBrains Mono', monospace;
}

.comparison-card-scores {
    display: flex;
    gap: 16px;
    margin-bottom: 12px;
}

.comparison-score {
    flex: 1;
    background: var(--bg-tertiary);
    border-radius: 8px;
    padding: 12px;
    text-align: center;
}

.comparison-score-label {
    display: block;
    font-size: 0.7rem;
    color: var(--text-muted);
    text-transform: uppercase;
    margin-bottom: 4px;
}

.comparison-score-value {
    font-size: 1.25rem;
    font-weight: 700;
}

.comparison-card-output {
    background: var(--bg-tertiary);
    border-radius: 8px;
    padding: 12px;
    font-size: 0.8125rem;
    color: var(--text-secondary);
    max-height: 150px;
    overflow-y: auto;
    line-height: 1.5;
}

.winner-badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 4px 8px;
    background: var(--accent-success);
    color: white;
    border-radius: 4px;
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
}

/* Mobile Responsive */
@media (max-width: 768px) {
    .quick-actions-bar {
        flex-direction: column;
        align-items: stretch;
    }
    
    .quick-actions-left,
    .quick-actions-right {
        justify-content: center;
    }
    
    .template-dropdown {
        left: 50%;
        transform: translateX(-50%);
        min-width: 90vw;
        max-width: 90vw;
    }
    
    .model-selection-row {
        flex-direction: column;
    }
    
    .comparison-grid {
        grid-template-columns: 1fr;
    }
    
    .result-header {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .toggle-text {
        display: none;
    }
    
    .btn-text {
        display: none;
    }
    
    .tooltip-trigger::after {
        left: auto;
        right: 0;
        transform: none;
    }
}

@media (max-width: 480px) {
    .scores-grid {
        grid-template-columns: 1fr 1fr;
    }
    
    .comparison-card-scores {
        flex-direction: column;
        gap: 8px;
    }
}
</style>
{% endblock %}

{% block scripts %}
<script>
// Model cost estimates (per 1K tokens, approximate)
const MODEL_COSTS = {
    'gpt-4o-mini': 0.00015,
    'gpt-4o': 0.005,
    'o1-preview': 0.015,
    'o1-mini': 0.003,
    'gpt-4-turbo': 0.01,
    'claude-3-5-sonnet-20241022': 0.003,
    'claude-3-5-haiku-20241022': 0.00025,
    'claude-3-opus-20240229': 0.015,
    'google/gemini-2.0-flash-exp': 0.0001,
    'google/gemini-1.5-pro': 0.00125,
    'google/gemini-1.5-flash': 0.000075,
    'meta-llama/llama-3.3-70b-instruct': 0.0004,
    'meta-llama/llama-3.2-90b-vision-instruct': 0.0009,
    'meta-llama/llama-3.1-405b-instruct': 0.003,
    'meta-llama/llama-3.2-3b-instruct:free': 0,
    'google/gemma-2-9b-it:free': 0,
    'mistralai/mistral-7b-instruct:free': 0,
    'qwen/qwen-2.5-7b-instruct:free': 0
};

let isComparisonMode = false;
let templates = [];

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    // Load template data if coming from Templates page
    const templatePrompt = sessionStorage.getItem('templatePrompt');
    const templateReference = sessionStorage.getItem('templateReference');
    
    if (templatePrompt) {
        document.getElementById('prompt-input').value = templatePrompt;
        sessionStorage.removeItem('templatePrompt');
    }
    if (templateReference) {
        document.getElementById('reference-input').value = templateReference;
        sessionStorage.removeItem('templateReference');
    }
    
    // Load templates for dropdown
    loadTemplates();
    
    // Update cost estimates on model change
    document.getElementById('model-select').addEventListener('change', updateCostEstimate);
    document.getElementById('model-select-2').addEventListener('change', updateCostEstimate);
    updateCostEstimate();
    
    // Close dropdown when clicking outside
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.template-selector')) {
            document.getElementById('template-dropdown').classList.remove('show');
        }
    });
});

// Load templates for dropdown
async function loadTemplates() {
    try {
        const response = await fetch('/api/templates');
        templates = await response.json();
        
        const list = document.getElementById('template-list');
        
        if (templates.length === 0) {
            list.innerHTML = '<div class="template-dropdown-loading">No templates yet. <a href="/templates">Create one</a></div>';
            return;
        }
        
        list.innerHTML = templates.slice(0, 5).map(t => `
            <div class="template-dropdown-item" onclick="applyTemplate('${t.id}')">
                <div class="template-dropdown-item-title">${escapeHtml(t.name)}</div>
                <div class="template-dropdown-item-desc">${escapeHtml(t.description || t.prompt.substring(0, 50))}</div>
            </div>
        `).join('');
    } catch (error) {
        console.error('Error loading templates:', error);
        document.getElementById('template-list').innerHTML = '<div class="template-dropdown-loading">Error loading templates</div>';
    }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function toggleTemplateDropdown() {
    document.getElementById('template-dropdown').classList.toggle('show');
}

function applyTemplate(templateId) {
    const template = templates.find(t => t.id === templateId);
    if (template) {
        document.getElementById('prompt-input').value = template.prompt;
        if (template.reference_text) {
            document.getElementById('reference-input').value = template.reference_text;
        }
        document.getElementById('template-dropdown').classList.remove('show');
    }
}

function toggleComparisonMode() {
    isComparisonMode = document.getElementById('comparison-mode').checked;
    const model2Group = document.getElementById('model-2-group');
    const badge1 = document.getElementById('model-badge-1');
    const btnText = document.getElementById('evaluate-btn-text');
    
    if (isComparisonMode) {
        model2Group.style.display = 'block';
        badge1.style.display = 'inline-block';
        btnText.textContent = 'Compare Models';
    } else {
        model2Group.style.display = 'none';
        badge1.style.display = 'none';
        btnText.textContent = 'Run Evaluation';
    }
    
    updateCostEstimate();
}

function updateCostEstimate() {
    const model1 = document.getElementById('model-select').value;
    const model2 = document.getElementById('model-select-2').value;
    
    // Estimate ~500 tokens per request
    const cost1 = MODEL_COSTS[model1] ? (MODEL_COSTS[model1] * 0.5).toFixed(4) : '0.001';
    const cost2 = MODEL_COSTS[model2] ? (MODEL_COSTS[model2] * 0.5).toFixed(4) : '0.003';
    
    document.getElementById('cost-value-1').textContent = cost1 == 0 ? 'Free' : `~$${cost1}`;
    document.getElementById('cost-value-2').textContent = cost2 == 0 ? 'Free' : `~$${cost2}`;
}

function formatCost(model) {
    const cost = MODEL_COSTS[model] ? (MODEL_COSTS[model] * 0.5).toFixed(4) : '0.001';
    return cost == 0 ? 'Free' : `~$${cost}`;
}

function getModelDisplayName(modelId) {
    const select = document.getElementById('model-select');
    for (let option of select.options) {
        if (option.value === modelId) {
            return option.text;
        }
    }
    return modelId;
}

// Form submission
document.getElementById('evaluate-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const btn = document.getElementById('evaluate-btn');
    const emptyState = document.getElementById('empty-state');
    const loadingState = document.getElementById('loading-state');
    const resultPanel = document.getElementById('result-panel');
    const comparisonResults = document.getElementById('comparison-results');
    
    // Show loading
    emptyState.style.display = 'none';
    resultPanel.style.display = 'none';
    comparisonResults.style.display = 'none';
    loadingState.style.display = 'block';
    btn.disabled = true;
    btn.innerHTML = '<div class="spinner"></div> Evaluating...';
    
    const prompt = document.getElementById('prompt-input').value;
    const promptVersion = document.getElementById('prompt-version').value;
    const referenceText = document.getElementById('reference-input').value || null;
    const model1 = document.getElementById('model-select').value;
    
    if (isComparisonMode) {
        const model2 = document.getElementById('model-select-2').value;
        document.getElementById('loading-title').textContent = 'Comparing Models...';
        document.getElementById('loading-text').textContent = 'Running evaluations on both models';
        
        await runComparison(prompt, promptVersion, referenceText, model1, model2);
    } else {
        document.getElementById('loading-title').textContent = 'Evaluating...';
        document.getElementById('loading-text').textContent = 'Generating LLM response and analyzing for hallucinations';
        
        await runSingleEvaluation(prompt, promptVersion, referenceText, model1);
    }
    
    btn.disabled = false;
    btn.innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polygon points="5 3 19 12 5 21 5 3"/>
        </svg>
        <span id="evaluate-btn-text">${isComparisonMode ? 'Compare Models' : 'Run Evaluation'}</span>
    `;
});

async function runSingleEvaluation(prompt, promptVersion, referenceText, model) {
    const loadingState = document.getElementById('loading-state');
    const emptyState = document.getElementById('empty-state');
    const resultPanel = document.getElementById('result-panel');
    
    const startTime = performance.now();
    
    try {
        const response = await fetch('/api/evaluate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                prompt: prompt,
                model_name: model,
                prompt_version: promptVersion,
                reference_text: referenceText
            })
        });
        
        const endTime = performance.now();
        const latency = ((endTime - startTime) / 1000).toFixed(2);
        
        const result = await response.json();
        
        if (result.error) {
            showAlert('Evaluation Error', result.error);
            loadingState.style.display = 'none';
            emptyState.style.display = 'block';
        } else {
            displaySingleResult(result, latency, model);
        }
    } catch (error) {
        showAlert('Error', error.message);
        loadingState.style.display = 'none';
        emptyState.style.display = 'block';
    }
}

async function runComparison(prompt, promptVersion, referenceText, model1, model2) {
    const loadingState = document.getElementById('loading-state');
    const emptyState = document.getElementById('empty-state');
    const comparisonResults = document.getElementById('comparison-results');
    
    const startTime1 = performance.now();
    
    try {
        // Run both evaluations in parallel
        const [response1, response2] = await Promise.all([
            fetch('/api/evaluate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    prompt: prompt,
                    model_name: model1,
                    prompt_version: promptVersion,
                    reference_text: referenceText
                })
            }),
            fetch('/api/evaluate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    prompt: prompt,
                    model_name: model2,
                    prompt_version: promptVersion,
                    reference_text: referenceText
                })
            })
        ]);
        
        const endTime = performance.now();
        const totalLatency = ((endTime - startTime1) / 1000).toFixed(2);
        
        const result1 = await response1.json();
        const result2 = await response2.json();
        
        if (result1.error || result2.error) {
            showAlert('Comparison Error', result1.error || result2.error);
            loadingState.style.display = 'none';
            emptyState.style.display = 'block';
        } else {
            displayComparisonResults(result1, result2, model1, model2, totalLatency);
        }
    } catch (error) {
        showAlert('Error', error.message);
        loadingState.style.display = 'none';
        emptyState.style.display = 'block';
    }
}

function displaySingleResult(result, latency, model) {
    const loadingState = document.getElementById('loading-state');
    const resultPanel = document.getElementById('result-panel');
    
    loadingState.style.display = 'none';
    resultPanel.style.display = 'block';
    
    // Status badge
    const statusBadge = document.getElementById('result-status');
    if (result.is_hallucination) {
        statusBadge.className = 'badge badge-danger';
        statusBadge.textContent = 'Hallucination Detected';
    } else {
        statusBadge.className = 'badge badge-success';
        statusBadge.textContent = 'Verified';
    }
    
    // Latency and cost
    document.getElementById('result-latency').querySelector('span:last-child').textContent = `${latency}s`;
    document.getElementById('result-cost').querySelector('span:last-child').textContent = formatCost(model);
    
    // Output
    document.getElementById('result-output').textContent = result.llm_output;
    
    // Scores
    const confidence = ((1 - result.overall_hallucination_score) * 100).toFixed(1);
    const hallucination = (result.overall_hallucination_score * 100).toFixed(1);
    const semantic = (result.semantic_similarity_score * 100).toFixed(1);
    const factcheck = (result.fact_check_score * 100).toFixed(1);
    
    document.getElementById('score-confidence').textContent = confidence + '%';
    document.getElementById('score-confidence').style.color = confidence > 70 ? 'var(--accent-success)' : confidence > 40 ? 'var(--accent-warning)' : 'var(--accent-danger)';
    
    document.getElementById('score-hallucination').textContent = hallucination + '%';
    document.getElementById('score-hallucination').style.color = hallucination < 30 ? 'var(--accent-success)' : hallucination < 60 ? 'var(--accent-warning)' : 'var(--accent-danger)';
    
    document.getElementById('score-semantic').textContent = semantic + '%';
    document.getElementById('score-semantic').style.color = semantic > 70 ? 'var(--accent-success)' : semantic > 40 ? 'var(--accent-warning)' : 'var(--accent-danger)';
    
    document.getElementById('score-factcheck').textContent = factcheck + '%';
    document.getElementById('score-factcheck').style.color = factcheck > 70 ? 'var(--accent-success)' : factcheck > 40 ? 'var(--accent-warning)' : 'var(--accent-danger)';
    
    // Analysis details
    const analysisDetails = document.getElementById('analysis-details');
    const factDetails = result.fact_check_details || {};
    const ruleDetails = result.rule_based_details || {};
    
    let detailsHtml = '<div style="display: flex; flex-direction: column; gap: 12px;">';
    
    if (factDetails.claims && factDetails.claims.length > 0) {
        detailsHtml += `
            <div style="background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; padding: 16px;">
                <div style="font-weight: 600; margin-bottom: 8px; font-size: 0.875rem;">Extracted Claims (${factDetails.total_claims || 0})</div>
                <div style="font-size: 0.8125rem; color: var(--text-secondary);">
                    ${factDetails.claims.slice(0, 3).map(c => `<div style="margin-bottom: 4px;">‚Ä¢ ${c.claim.substring(0, 100)}${c.claim.length > 100 ? '...' : ''}</div>`).join('')}
                </div>
            </div>
        `;
    }
    
    if (ruleDetails.suspicious_patterns && ruleDetails.suspicious_patterns.length > 0) {
        detailsHtml += `
            <div style="background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; padding: 16px;">
                <div style="font-weight: 600; margin-bottom: 8px; font-size: 0.875rem;">Suspicious Patterns Found</div>
                <div style="font-size: 0.8125rem; color: var(--text-secondary);">
                    ${ruleDetails.suspicious_patterns.map(p => `<div style="margin-bottom: 4px;">‚Ä¢ ${p.count} occurrence(s): ${p.matches.slice(0, 3).join(', ')}</div>`).join('')}
                </div>
            </div>
        `;
    }
    
    detailsHtml += '</div>';
    analysisDetails.innerHTML = detailsHtml;
}

function displayComparisonResults(result1, result2, model1, model2, totalLatency) {
    const loadingState = document.getElementById('loading-state');
    const comparisonResults = document.getElementById('comparison-results');
    
    loadingState.style.display = 'none';
    comparisonResults.style.display = 'block';
    
    const confidence1 = ((1 - result1.overall_hallucination_score) * 100).toFixed(1);
    const confidence2 = ((1 - result2.overall_hallucination_score) * 100).toFixed(1);
    const hallucination1 = (result1.overall_hallucination_score * 100).toFixed(1);
    const hallucination2 = (result2.overall_hallucination_score * 100).toFixed(1);
    
    // Determine winner
    let winner = null;
    if (parseFloat(confidence1) > parseFloat(confidence2) + 5) {
        winner = 1;
    } else if (parseFloat(confidence2) > parseFloat(confidence1) + 5) {
        winner = 2;
    }
    
    // Summary
    const summaryEl = document.getElementById('comparison-summary');
    if (winner === 1) {
        summaryEl.innerHTML = `<span class="winner-badge">üèÜ ${getModelDisplayName(model1)} wins</span>`;
    } else if (winner === 2) {
        summaryEl.innerHTML = `<span class="winner-badge">üèÜ ${getModelDisplayName(model2)} wins</span>`;
    } else {
        summaryEl.innerHTML = `<span style="color: var(--text-muted);">Results are similar</span>`;
    }
    
    // Model 1
    document.getElementById('comparison-model-1').textContent = getModelDisplayName(model1);
    const status1 = document.getElementById('comparison-status-1');
    status1.className = result1.is_hallucination ? 'badge badge-danger' : 'badge badge-success';
    status1.textContent = result1.is_hallucination ? 'Hallucination' : 'Verified';
    document.getElementById('comparison-latency-1').textContent = `‚è± ${totalLatency}s`;
    document.getElementById('comparison-cost-1').textContent = `üí∞ ${formatCost(model1)}`;
    document.getElementById('comparison-confidence-1').textContent = confidence1 + '%';
    document.getElementById('comparison-confidence-1').style.color = confidence1 > 70 ? 'var(--accent-success)' : 'var(--accent-warning)';
    document.getElementById('comparison-hallucination-1').textContent = hallucination1 + '%';
    document.getElementById('comparison-hallucination-1').style.color = hallucination1 < 30 ? 'var(--accent-success)' : 'var(--accent-danger)';
    document.getElementById('comparison-output-1').textContent = result1.llm_output;
    
    // Model 2
    document.getElementById('comparison-model-2').textContent = getModelDisplayName(model2);
    const status2 = document.getElementById('comparison-status-2');
    status2.className = result2.is_hallucination ? 'badge badge-danger' : 'badge badge-success';
    status2.textContent = result2.is_hallucination ? 'Hallucination' : 'Verified';
    document.getElementById('comparison-latency-2').textContent = `‚è± ${totalLatency}s`;
    document.getElementById('comparison-cost-2').textContent = `üí∞ ${formatCost(model2)}`;
    document.getElementById('comparison-confidence-2').textContent = confidence2 + '%';
    document.getElementById('comparison-confidence-2').style.color = confidence2 > 70 ? 'var(--accent-success)' : 'var(--accent-warning)';
    document.getElementById('comparison-hallucination-2').textContent = hallucination2 + '%';
    document.getElementById('comparison-hallucination-2').style.color = hallucination2 < 30 ? 'var(--accent-success)' : 'var(--accent-danger)';
    document.getElementById('comparison-output-2').textContent = result2.llm_output;
    
    // Highlight winner
    document.getElementById('comparison-card-1').style.borderLeft = winner === 1 ? '3px solid var(--accent-success)' : 'none';
    document.getElementById('comparison-card-2').style.borderLeft = winner === 2 ? '3px solid var(--accent-success)' : 'none';
}
</script>
{% endblock %}
