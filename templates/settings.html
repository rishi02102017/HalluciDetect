{% extends "base.html" %}

{% block title %}Settings - HalluciDetect{% endblock %}
{% block header_title %}Settings{% endblock %}

{% block content %}
<div class="settings-container" style="max-width: 800px;">
    
    <!-- Preferences Section -->
    <div class="card" style="margin-bottom: 24px;">
        <div class="card-header">
            <h3 class="card-title">Preferences</h3>
        </div>
        <div class="card-body">
            <div class="form-group">
                <label class="form-label">Default Model</label>
                <select class="form-select" id="default-model">
                    <optgroup label="Recommended">
                        <option value="gpt-4o-mini" selected>GPT-4o Mini (Fast & Affordable)</option>
                        <option value="claude-3-5-sonnet-20241022">Claude 3.5 Sonnet (Best Quality)</option>
                    </optgroup>
                    <optgroup label="OpenAI">
                        <option value="gpt-4o">GPT-4o</option>
                        <option value="o1-preview">o1 Preview (Advanced Reasoning)</option>
                        <option value="o1-mini">o1 Mini</option>
                        <option value="gpt-4-turbo">GPT-4 Turbo</option>
                    </optgroup>
                    <optgroup label="Anthropic">
                        <option value="claude-3-5-haiku-20241022">Claude 3.5 Haiku (Fast)</option>
                        <option value="claude-3-opus-20240229">Claude 3 Opus</option>
                    </optgroup>
                    <optgroup label="Google">
                        <option value="google/gemini-2.0-flash-exp">Gemini 2.0 Flash</option>
                        <option value="google/gemini-1.5-pro">Gemini 1.5 Pro</option>
                        <option value="google/gemini-1.5-flash">Gemini 1.5 Flash</option>
                    </optgroup>
                    <optgroup label="Meta Llama">
                        <option value="meta-llama/llama-3.3-70b-instruct">Llama 3.3 70B</option>
                        <option value="meta-llama/llama-3.2-90b-vision-instruct">Llama 3.2 90B Vision</option>
                        <option value="meta-llama/llama-3.1-405b-instruct">Llama 3.1 405B</option>
                    </optgroup>
                    <optgroup label="Free Models">
                        <option value="meta-llama/llama-3.2-3b-instruct:free">Llama 3.2 3B (Free)</option>
                        <option value="google/gemma-2-9b-it:free">Gemma 2 9B (Free)</option>
                        <option value="mistralai/mistral-7b-instruct:free">Mistral 7B (Free)</option>
                        <option value="qwen/qwen-2.5-7b-instruct:free">Qwen 2.5 7B (Free)</option>
                    </optgroup>
                </select>
                <p class="form-hint">This model will be pre-selected in the Playground</p>
            </div>
        </div>
    </div>
    
    <!-- Your Data Section -->
    <div class="card" style="margin-bottom: 24px;">
        <div class="card-header">
            <h3 class="card-title">Your Data</h3>
        </div>
        <div class="card-body">
            <div style="display: flex; gap: 16px; margin-bottom: 20px;">
                <div style="flex: 1; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 8px; padding: 20px; text-align: center;">
                    <div style="font-size: 2rem; font-weight: 700; color: var(--accent-primary);" id="total-evaluations">--</div>
                    <div style="font-size: 0.875rem; color: var(--text-muted);">Total Evaluations</div>
                </div>
                <div style="flex: 1; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 8px; padding: 20px; text-align: center;">
                    <div style="font-size: 2rem; font-weight: 700; color: var(--accent-success);" id="total-templates">--</div>
                    <div style="font-size: 0.875rem; color: var(--text-muted);">Saved Templates</div>
                </div>
            </div>
            
            <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                <a href="/api/results/export?format=csv" class="btn btn-secondary" download>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;">
                        <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
                        <polyline points="7 10 12 15 17 10"/>
                        <line x1="12" y1="15" x2="12" y2="3"/>
                    </svg>
                    Export Results (CSV)
                </a>
                <a href="/api/templates/export/json" class="btn btn-secondary" download>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;">
                        <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
                        <polyline points="7 10 12 15 17 10"/>
                        <line x1="12" y1="15" x2="12" y2="3"/>
                    </svg>
                    Export Templates (JSON)
                </a>
            </div>
        </div>
    </div>
    
    <!-- Supported Models (Informational) -->
    <div class="card" style="margin-bottom: 24px;">
        <div class="card-header" style="cursor: pointer;" onclick="toggleModels()">
            <h3 class="card-title" style="display: flex; align-items: center; gap: 8px;">
                Supported Models
                <svg id="models-chevron" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px; transition: transform 0.2s;">
                    <polyline points="6 9 12 15 18 9"/>
                </svg>
            </h3>
        </div>
        <div class="card-body" id="models-container" style="display: none;">
            <p style="color: var(--text-muted); font-size: 0.875rem; margin-bottom: 16px;">
                HalluciDetect supports 20+ LLMs from leading providers. All models are accessed through secure API connections.
            </p>
            <div id="models-list">Loading...</div>
        </div>
    </div>
    
    <!-- Account Actions -->
    <div class="card" style="margin-bottom: 24px;">
        <div class="card-header">
            <h3 class="card-title">Account</h3>
        </div>
        <div class="card-body">
            <div style="display: flex; gap: 12px; flex-wrap: wrap; align-items: center;">
                <a href="{{ url_for('profile') }}" class="btn btn-secondary">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;">
                        <path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/>
                        <circle cx="12" cy="7" r="4"/>
                    </svg>
                    Manage Profile
                </a>
                <a href="{{ url_for('logout') }}" class="btn btn-secondary" style="color: var(--accent-danger);">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;">
                        <path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4"/>
                        <polyline points="16 17 21 12 16 7"/>
                        <line x1="21" y1="12" x2="9" y2="12"/>
                    </svg>
                    Sign Out
                </a>
            </div>
        </div>
    </div>
    
    <!-- Appearance (Theme Picker) -->
    <div class="theme-section" style="padding: 16px 20px; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 12px;">
        <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 16px;">
            <div style="display: flex; align-items: center; gap: 12px;">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 18px; height: 18px; color: var(--text-muted);">
                    <circle cx="12" cy="12" r="10"/>
                    <path d="M12 2a10 10 0 0 1 0 20"/>
                </svg>
                <span style="font-size: 0.875rem; color: var(--text-secondary);">Accent Color</span>
                <span id="theme-status" style="font-size: 0.75rem; color: var(--accent-success); display: none; margin-left: 8px;">✓ Saved</span>
            </div>
            <div class="theme-picker-compact" id="themePicker">
                <div class="theme-dot" data-theme="indigo" title="Indigo"></div>
                <div class="theme-dot" data-theme="purple" title="Purple"></div>
                <div class="theme-dot" data-theme="violet" title="Violet"></div>
                <div class="theme-dot" data-theme="blue" title="Blue"></div>
                <div class="theme-dot" data-theme="cyan" title="Cyan"></div>
                <div class="theme-dot" data-theme="teal" title="Teal"></div>
                <div class="theme-dot" data-theme="green" title="Green"></div>
                <div class="theme-dot" data-theme="lime" title="Lime"></div>
                <div class="theme-dot" data-theme="yellow" title="Yellow"></div>
                <div class="theme-dot" data-theme="orange" title="Orange"></div>
                <div class="theme-dot" data-theme="red" title="Red"></div>
                <div class="theme-dot" data-theme="rose" title="Rose"></div>
                <div class="theme-dot" data-theme="pink" title="Pink"></div>
                <div class="theme-dot" data-theme="fuchsia" title="Fuchsia"></div>
                <div class="theme-dot" data-theme="slate" title="Slate"></div>
            </div>
        </div>
    </div>
    
    <!-- Version info (subtle footer) -->
    <div style="text-align: center; margin-top: 32px; padding: 16px; color: var(--text-muted); font-size: 0.75rem;">
        HalluciDetect v1.3.0 · Built by <a href="https://www.linkedin.com/in/jyotishman-das" target="_blank" style="color: var(--accent-primary);">Jyotishman Das</a>
    </div>
    
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    loadUserStats();
    initThemePicker();
});

// ==================== User Stats ====================

async function loadUserStats() {
    try {
        const [resultsRes, templatesRes] = await Promise.all([
            fetch('/api/results?limit=10000'),
            fetch('/api/templates')
        ]);
        
        const results = await resultsRes.json();
        const templates = await templatesRes.json();
        
        document.getElementById('total-evaluations').textContent = Array.isArray(results) ? results.length : 0;
        document.getElementById('total-templates').textContent = Array.isArray(templates) ? templates.length : 0;
    } catch (error) {
        console.error('Error loading stats:', error);
    }
}

// ==================== Models Toggle ====================

let modelsLoaded = false;

function toggleModels() {
    const container = document.getElementById('models-container');
    const chevron = document.getElementById('models-chevron');
    
    if (container.style.display === 'none') {
        container.style.display = 'block';
        chevron.style.transform = 'rotate(180deg)';
        if (!modelsLoaded) {
            loadModels();
            modelsLoaded = true;
        }
    } else {
        container.style.display = 'none';
        chevron.style.transform = 'rotate(0deg)';
    }
}

async function loadModels() {
    try {
        const response = await fetch('/api/models');
        const models = await response.json();
        
        const container = document.getElementById('models-list');
        let html = '';
        
        for (const [provider, modelList] of Object.entries(models)) {
            if (modelList.length === 0) continue;
            
            html += `
                <div style="margin-bottom: 16px;">
                    <div style="font-size: 0.75rem; font-weight: 600; text-transform: uppercase; color: var(--text-muted); margin-bottom: 8px;">${provider}</div>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                        ${modelList.map(m => `<span class="badge badge-neutral">${m}</span>`).join('')}
                    </div>
                </div>
            `;
        }
        
        container.innerHTML = html || '<p class="text-muted">Models list not available.</p>';
    } catch (error) {
        document.getElementById('models-list').innerHTML = '<p class="text-muted">Error loading models</p>';
    }
}

// ==================== Theme System ====================

function initThemePicker() {
    const picker = document.getElementById('themePicker');
    if (!picker) return;
    
    const dots = picker.querySelectorAll('.theme-dot');
    
    // Load current theme
    const currentTheme = localStorage.getItem('hallucidetect-theme') || 'indigo';
    setActiveTheme(currentTheme);
    
    // Add click handlers
    dots.forEach(dot => {
        dot.addEventListener('click', function() {
            const theme = this.getAttribute('data-theme');
            applyTheme(theme);
            saveTheme(theme);
        });
    });
}

function setActiveTheme(theme) {
    const dots = document.querySelectorAll('.theme-dot');
    dots.forEach(dot => {
        dot.classList.remove('active');
        if (dot.getAttribute('data-theme') === theme) {
            dot.classList.add('active');
        }
    });
}

function applyTheme(theme) {
    document.documentElement.setAttribute('data-theme', theme);
    setActiveTheme(theme);
}

async function saveTheme(theme) {
    localStorage.setItem('hallucidetect-theme', theme);
    
    try {
        await fetch('/api/user/theme', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ theme: theme })
        });
    } catch (error) {
        // Silently fail - localStorage is the fallback
    }
    showThemeStatus();
}

function showThemeStatus() {
    const status = document.getElementById('theme-status');
    if (status) {
        status.style.display = 'inline';
        setTimeout(() => { status.style.display = 'none'; }, 1500);
    }
}
</script>
{% endblock %}
